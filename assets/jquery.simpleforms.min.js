/*--
 * SimpleForms for ProcessWire
 * A simple form processor. Uses AJAX, configurable with JSON. Front-end is up to you.
 *
 * Front-end jQuery plugin
 *
 * Copyright (c) 2015, Mike Rockett. All Rights Reserved.
 * Licence: MIT License - http://mit-license.org/
 */
!function(e,t){var s=function(){for(var e=arguments[0],t="ucfirst",s=0;s<arguments.length-1;s++){var r=new RegExp("\\{("+t+":)?"+s+"\\}","igm"),n=(new RegExp("\\[([a-z]+)\\|([a-z]+):("+s+")\\]","igm"),arguments[s+1]);e.match(r)&&e.match(r)[0].indexOf(t)>=0&&(n=n.charAt(0).toUpperCase()+n.slice(1)),e=e.replace(r,n)}return e},r=function(e,t){("undefined"==typeof t||null===t)&&(t=!0);var r="data-sf-"+e;return t===!0&&(r=s("[{0}]",r)),r};e.fn.sf_serialiseObject=function(){var t={},s=this.serializeArray();return e.each(s,function(){void 0!==t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t};var n=function(e){if(Object.keys)return Object.keys(e).length;var t=0;for(var s in e)this.hasOwnProperty(s)&&t++;return t};e.fn.prepareSimpleForms=function(t){var a={interimButtonText:"Just a moment...",logErrors:!0,processingClass:"processing",scroll:{enabled:!0,offset:0,duration:500,easing:"swing"},serverErrorAlert:"Something went wrong on the server, and so this form could not be submitted. The form has been left as-is so that you may leave it open and try again in a few minutes.",events:{submitStart:function(e){},submitEnd:function(e){},success:null,failure:null,serverError:null}},i=e.extend(!0,a,t),o=this;e(":input[disabled]",o).attr(r("disabled",!1),"disabled"),e.each(["inputmask|mask","formatter|pattern"],function(t,r){var r=r.split("|"),n=r[0],a=r[1];i[n]&&e.fn[n]&&e.each(i[n],function(t,r){if("string"===e.type(r)){var i=r,r={};r[a]=i}e(s("[name={0}]",t),o)[n](r)})}),e("input[type=submit]",this).val(function(){return e(this).data("value")}),this.on("submit",function(t){t.preventDefault();var a=new FormData(o[0]),u=function(t){var n=e(s(":input:not([{0}])",r("disabled",!1)),o);switch(t){case 0:n.prop("disabled",!0);break;case 1:n.prop("disabled",!1)}},l=function(){o.addClass(i.processingClass),u(0),e("input[type=submit]",o).val(i.interimButtonText),e.isFunction(i.events.submitStart)&&i.events.submitStart(o)},c=function(){o.removeClass(i.processingClass),u(1),e("input[type=submit]",o).val(function(){return e(this).data("value")}),e.isFunction(i.events.submitEnd)&&i.events.submitEnd(o)};return l(),e.ajax(o.attr("action"),{async:!0,data:a,processData:!1,contentType:!1,dataType:"json",type:"post",method:"post",statusCode:{500:function(t){var s=e.parseJSON(t.responseText);i.logErrors===!0&&console.log(s.error),e.isFunction(i.events.serverError)?i.events.serverError(s.error):alert(i.serverErrorAlert)},422:function(t){var a=e.parseJSON(t.responseText),u=a.errors,l=(n(u),a.error);e.isFunction(i.events.failure)?i.events.failure(o,u,l):(e(r("formerror"),o).hide().html(l).show(),e(r("fielderror"),o).hide(),e(":input",o).removeAttr(r("fieldhaserror",!1)),e.each(u,function(t,n){n instanceof Array&&console.log(n[0]);var a=s("[name={0}]",t);e(a,o).attr(r("fieldhaserror",!1),""),e(s("[{0}={1}]",r("fielderror",!1),t),o).html(n).show()}));var c=function(){for(var e in u)return e};e(s("[name={0}]",c()),o).focus()},200:function(t){e.isFunction(i.events.success)?i.events.success(o,t.success):o.html(s('<div data-sf-success class="sfSuccessMessage">{0}</div>',t.success))}}}).always(function(){i.scroll.enabled&&e("html,body").animate({scrollTop:o.offset().top-i.scroll.offset},{duration:i.scroll.duration,easing:i.scroll.easing}),c()}),!0})},t.allSimpleForms=function(){return"[data-sf!=''][data-sf]"},t.simpleForms=function(t){e(allSimpleForms()).prepareSimpleForms(t)}}(jQuery,window);